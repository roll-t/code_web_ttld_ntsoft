MISA.Navigation={uiConfig:typeof UIConfig!="undefined"?UIConfig:{},cacheUcInfo:{},cacheStyle:[],cacheJs:[],userControlForAjax:false,controlServiceName:'ControlService',navigatePage:function(navConfig,popstate){var me=this,formID=navConfig.formID;if(MISA.CommonFn.checkLicenseRule(formID)){if(MISA.CommonFn.checkPermission(formID,MISA.Enumeration.EditMode.View)){if(me.uiConfig&&me.uiConfig[formID]){var cfg=me.uiConfig[formID];if(cfg&&typeof cfg==="object"&&cfg.type===MISA.Enumeration.UIConfigType.PageInline){me.showHideControlByFormID(formID);if(pnMainContent){$.extend(cfg,navConfig,{pnContent:pnMainContent});me.showUc(cfg,popstate);}else{var url=cfg.pagePath,target=navConfig.target||"_blank";window.open(url,target);}}else{var url=cfg.pagePath,target=navConfig.target||"_blank";window.open(url,target);}}else{MISA.MessageBox.showWarning(MISA.Resource.GlobalResource.MissingConfig);}}else{MISA.MessageBox.showWarning(MISA.Resource.GlobalResource.NotPermission);}}else{MISA.MessageBox.showWarning(MISA.Resource.GlobalResource.NotLicense);}},showHideControlByFormID:function(formID){var me=this;switch(formID){case "SalaryDashboard":case "EstimateAcceptAddition":case "EstimateAdditionAccept":case "SalaryTable":case "EstimateAddition":case "EstimateSummaryExtend":case "Timekeeping":case "CheckWorkerList":case "CalculateOrther":case "CalculateDeduction":case "PersonalIncomeTax":case "PersonalTaxCodeRegistration":case "SettlementTax":case "SalarySetupRetroactive":case "CollectionOfSalary":case "SalaryTableSend":case "SalaryCreateReform":case "SalarySummaryReform":case "Report":var arrayYears=Object.entries(MISA.Enumeration.YearCalculator).map((e)=>({[e[0]]:e[1]}));var indexYear=arrayYears.findIndex(x=>x[MISA.ContextData.SalaryYear]);App.cbYearCalculator.rebuildStore('YearCalculator','',indexYear);App.cbYearCalculator.show();App.lblWorkYear.setText("Năm làm việc:");App.lblWorkYear.show();App.cbCreationPeriod.hide();App.cbSalaryMonth.hide();break;case "SalaryCreatePlan":case "EstimateAccept":case "EstimateSummary":case "SAVEstimateSummary":case "SAVEstimateSummaryExtend":case "BudgetAdjustment":var arrayYears=Object.entries(MISA.Enumeration.YearCalculator).map((e)=>({[e[0]]:e[1]}));var indexYear=arrayYears.findIndex(x=>x[MISA.ContextData.SalaryYear]);App.cbYearCalculator.rebuildStore('YearCalculator','',indexYear);App.cbYearCalculator.show();App.lblWorkYear.setText("Năm kế hoạch:");App.lblWorkYear.show();App.cbCreationPeriod.hide();App.cbSalaryMonth.hide();break;case "SalaryAccept":case "SalaryTableSendSummary":App.lblWorkYear.show();App.cbYearCalculator.show();App.cbSalaryMonth.show();App.cbCreationPeriod.hide();break;case "TaxDeductionVoucher":case "TaxSettlement":case "RegistrationDependents":App.lblWorkYear.show();App.cbYearCalculator.show();App.cbSalaryMonth.hide();App.cbCreationPeriod.hide();break;default:App.lblWorkYear.hide();App.cbYearCalculator.hide();App.cbCreationPeriod.hide();App.cbSalaryMonth.hide();}},navigatePageQLTH:function(qlthApp){var me=this;MISA.Service.ajax(me.controlServiceName,"GetQLTHURL",{qlthApp:qlthApp},{async:true},function(msg){location.href=msg.Data;});},showUc:function(navConfig,popstate){var me=this,navConfig=navConfig||{},key=navConfig.key,cacheValue={},target=navConfig.target;const cfg=me.uiConfig[key];if(navConfig.rebuildHtml){var userControlLoaderID=Ext.ComponentQuery.query('[tag='+target+']');if(Ext.isArray(userControlLoaderID)&&userControlLoaderID.length>0){userControlLoaderID[0].destroy();}}
const getFormVisible=(panel)=>{if(panel&&panel.items){return panel.items.items.find(item=>item.isVisible());}}
const cacheUcInfo=me.cacheUcInfo[key];if(!cacheUcInfo){$.each(me.cacheUcInfo,function(name,item){if(item.uiConfig.group===key){delete me.cacheUcInfo[name];}});}
if(cacheUcInfo){cacheValue=me.cacheUcInfo[key];var cacheConfig=cacheValue.config;switch(cacheValue.uiConfig.type){case MISA.Enumeration.UIConfigType.PageInline:cacheValue.config=navConfig;const pnContent=navConfig.pnContent;if(pnContent){const currentPanel=getFormVisible(pnContent);if(currentPanel){currentPanel.hide();}
const panelId=navConfig.panelId;if(panelId){const panel=Ext.getCmp(panelId);if(panel){if(!popstate){me.pushHistoryState(navConfig);}
panel.show();}}}
break;case MISA.Enumeration.UIConfigType.Inline:cacheValue.config=navConfig;break;case MISA.Enumeration.UIConfigType.PopUp:if(cacheConfig.wd){navConfig.wd=cacheConfig.wd;cacheValue.config=navConfig;navConfig.wd.show();}
break;}
navConfig.jsInstance=cacheConfig.jsInstance;if(navConfig.rebuildHtml&&!Ext.isEmpty(cacheConfig.toScript)){navConfig.toScript=cacheConfig.toScript;eval(navConfig.toScript);var configClone=Ext.clone(navConfig.jsInstance.getConfigObject);var className=Ext.getClassName(navConfig.jsInstance);navConfig.jsInstance=Ext.create(Ext.getClassName(navConfig.jsInstance));navConfig.jsInstance.getConfigObject=configClone;me.initForm(navConfig);}else{me.loadForm(navConfig);}}else{me.uiConfig=Object.keys(me.uiConfig).length>0?me.uiConfig:UIConfig;if(me.uiConfig&&me.uiConfig[key]){var loadFn=function(){var callbackFn=function(toScript,options){if(cfg.script.jsObject){var js=eval(cfg.script.jsObject);navConfig.jsInstance=js;}
if(navConfig.rebuildHtml){navConfig.toScript=toScript;}
me.cacheUcInfo[key]=cacheValue;let config=undefined;if(options&&options.config){config=options.config
if(config.type===MISA.Enumeration.UIConfigType.PageInline&&!popstate){me.pushHistoryState(config);}}
me.initForm(navConfig);};cacheValue.uiConfig=cfg;switch(cfg.type){case MISA.Enumeration.UIConfigType.PageInline:cacheValue.config=navConfig;const pnContent=cfg.pnContent;if(pnContent){const currentPanel=getFormVisible(pnContent);if(currentPanel){currentPanel.hide();}
const panelId='{0}_{1}'.format(key,Ext.id('',"ms"));navConfig.panelId='pn_{0}'.format(panelId);me.loadUserControl(cfg.key,pnContent.getId(),callbackFn,{params:{id:panelId},cfg:cfg});}
break;case MISA.Enumeration.UIConfigType.Inline:cacheValue.config=navConfig;me.loadUserControl(cfg.key,target,callbackFn,{cfg:cfg});break;case MISA.Enumeration.UIConfigType.PopUp:var layoutConfig=cfg.layout,layout,wd,wdTitle;wdTitle=cfg.title?cfg.title:MISA.Resource.TitleResource[cfg.titleResource];cls=layoutConfig.cls?'m-popup '+layoutConfig.cls:'m-popup';if(layoutConfig){layout={title:wdTitle,width:layoutConfig.width,height:layoutConfig.height,border:layoutConfig.border,layout:'fit',bodyCls:'m-popup-body',resizable:false,cls:cls,modal:true}}
wd=Ext.create("Ext.Window",layout);wd.show();navConfig.wd=wd;cacheValue.config=navConfig;me.loadUserControl(cfg.key,wd.getId(),callbackFn);break;}}
var stylePaths=Ext.Array.difference(Ext.isArray(cfg.style.path)?cfg.style.path:[cfg.style.path],me.cacheStyle);if(stylePaths.length>0){Ext.each(stylePaths,function(item){if(!Ext.isEmpty(item)){var urlStyle="<link href='"+item+"' rel='stylesheet' type='text/css'>";$("head").append(urlStyle);me.cacheStyle.push(item);}});}
var scriptPaths=Ext.Array.difference(Ext.isArray(cfg.script.path)?cfg.script.path:[cfg.script.path],me.cacheJs);if(scriptPaths.length>0){var opt={url:scriptPaths,onLoad:function(){Ext.each(scriptPaths,function(item){me.cacheJs.push(item);});loadFn();}};Ext.Loader.loadScript(opt);}else{loadFn();}}}},initForm:function(navConfig){var me=this;if(navConfig.jsInstance){if(typeof navConfig.jsInstance.applyConfig=="function"){if(navConfig.type===MISA.Enumeration.UIConfigType.PageInline){navConfig.jsInstance.applyConfig({});eval(me.uiConfig[navConfig.key].script.jsObject+"= navConfig.jsInstance");}else{navConfig.jsInstance.applyConfig({},true);eval(me.uiConfig[navConfig.key].script.jsObject+"= navConfig.jsInstance");me.loadForm(navConfig);}}}},loadForm:function(navConfig){var me=this;if(navConfig.jsInstance){navConfig.jsInstance.loadForm(navConfig);if(typeof vpMain!='undefined'&&vpMain&&vpMain.updateLayout){setTimeout(function(){vpMain.updateLayout();},100)}}},loadUserControl:function(key,target,callback,options){var me=this,cmp=Ext.getCmp(target);MISA.CommonFn.showMask(cmp);let params={"key":key,"target":target}
if(options&&options.params){$.extend(params,options.params);}
me.userControlForAjax=true;MISA.Service.ajax(me.controlServiceName,me.getMethodNameToLoadUserControl(key),params,{async:true},function(msg){MISA.CommonFn.hideMask(cmp);switch(msg.Status){case MISA.Enumeration.ServiceResult.Success:eval(msg.Data);if(typeof callback=='function'){let config={};if(options&&options.cfg){config=options.cfg;}
callback(msg.Data,{config:config});}
break;case MISA.Enumeration.ServiceResult.Fail:MISA.ExceptionManager.handledServiceResult(msg.Message);break;case MISA.Enumeration.ServiceResult.RuntimeError:MISA.ExceptionManager.handledServiceResult(msg);break;}});},getMethodNameToLoadUserControl:function(key){return 'GetUserControl';},pushHistoryState:function(cfg){const me=this;if(cfg&&cfg.pagePath){const protocol=window.location.protocol;const host=window.location.host;const url='{0}//{1}{2}'.format(protocol,host,cfg.pagePath.replace('.aspx','').replace('~',''));window.history.pushState(cfg.key,'',url)}else{console.error('Thiếu cấu hình pagePath trong UIConfig');}},}