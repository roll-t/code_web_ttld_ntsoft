Ext.define('MISA.Control.MISACombobox',{mixins:['MISA.Mixin.ControlBinding'],xtype:'misacombobox',extend:'Ext.form.field.ComboBox',alias:'widget.misacombobox',displayField:null,valueField:null,blankText:MISA.Resource.ControlResource.blankText,entityName:'',templateId:'',autoGenerateStore:true,createFullModel:false,getDataURL:'',autoLoadData:false,pagingData:false,disableCreateProxy:false,customColumns:'',filterFields:null,columnsConfig:null,autoSelect:true,selectOnFocus:false,selectOnTab:true,rawValueSplitSeperator:'; ',valueSplitSeperatorInSign:':',forceSelection:false,clearFilterOnBlur:true,selectedIndex:-1,labelTooltip:'',labelableRenderTpl:MISA.Constant.LabelableRenderTpl,constructor:function(config){var me=this;me.customConfig(config);me.callParent(arguments);},customConfig:function(config){},initComponent:function(){var me=this;if(!me.columnConfigJson&&me.customColumns){me.columnConfigJson=MISA.CommonFn.parseCustomColumn(me.customColumns);}
me.buildColumnsConfig();me.buildFilterFields();me.minChars=0;if(!me.forceSelection){me.editable=true;}
me.typeAhead=false;var store=me.buildStore();if(store){me.store=store;}
if(!me.allowBlank){me.labelCls+=' misa-control-label-required';}
me.buildColumnTemplate();me.callParent(arguments);},createPicker:function(){var me=this,picker=null;switch(me.pickerType){case 'TimeSheetSign':var gridId=me.id+'_grid_picker';var config={floating:true,id:gridId,cls:'m-gridpanel m-grid-timesheet',"itemKey":"TimeSheetSignID","entityName":"TimeSheetSign","getDataURL":"~/Service/SalaryService.svc/json/GetTimeSheetSignPaging",autoGenerateStore:true,createFullModel:true,customModelFields:'TimeSheetSignID,TimeSheetSignName,TimeSheetSignCode',width:480,maxHeight:400,editable:true,selModel:Ext.create('Ext.selection.CheckboxModel',{mode:'MULTI',showHeaderCheckbox:false,checkOnly:true,headerWidth:30}),listeners:{beforeEdit:function(item,e){if(e.field=='TotalHour'){var recordId=e.record.id,selection=e.grid.getSelection()?e.grid.getSelection().mapValuesByKey('id'):[];return selection.contains(recordId)&&e.record.get('TimeKeepingType')!=1;}else{return false;}},},viewConfig:{getRowClass:function(record,rowIndex,rowParams,store){return record.get('TimeKeepingType')==1?'TimeSheetPicker-grid-raw':'';}},sort:'SortOrder',columns:{items:[{xtype:'misanumbercolumn',showFilterButton:false,text:'Thời gian',dataIndex:"TotalHour",sortable:false,minValue:0.00,maxValue:999.99,dataType:MISA.Enumeration.DataType.CustomType,width:90,allowBlank:true,tdCls:"TimeSheetPicker-TotalHour-td"},{xtype:'misacolumn',showFilterButton:false,text:'Ký hiệu',dataIndex:"TimeSheetSignCode",sortable:false,readOnly:true,width:120},{xtype:'misacolumn',showFilterButton:false,text:'Tên ký hiệu chấm công',dataIndex:"TimeSheetSignName",sortable:false,readOnly:true,flex:1,minWidth:200}]},customStoreParameter:function(operation){return{apply:{"customParam":JSON.stringify({OrganizationID:MISA.ContextData.OrganizationID,TimeSheetType:me.timeSheetType,ViewName:'View_TimeSheetSignByType'}),"limit":0,"filterHeader":{}}};}};picker=Ext.create('MISA.Control.MISAGridPanel',config);me.store=picker.store;me.isFreeText=true;me.disableCreateProxy=false;picker.store.proxy.combobox=me;me.onBindStore(me.store);picker.refresh=function(){picker.clearSelection();};me.matchFieldWidth=false;break;case 'TimeSheetSignOvertime':var gridId=me.id+'_grid_picker';var config={floating:true,id:gridId,cls:'m-gridpanel m-grid-timesheet',"itemKey":"TimeSheetSignID","entityName":"TimeSheetSign","getDataURL":"~/Service/SalaryService.svc/json/GetTimeSheetSignPagingOvertime",autoGenerateStore:true,createFullModel:true,customModelFields:'TimeSheetSignID,TimeSheetSignName,TimeSheetSignCode',width:480,maxHeight:400,editable:true,selModel:Ext.create('Ext.selection.CheckboxModel',{mode:'MULTI',showHeaderCheckbox:false,checkOnly:true,headerWidth:30}),listeners:{beforeEdit:function(item,e){if(e.field=='TotalHour'){var recordId=e.record.id,selection=e.grid.getSelection()?e.grid.getSelection().mapValuesByKey('id'):[];return selection.contains(recordId)&&e.record.get('TimeKeepingType')!=1;}else{return false;}},},viewConfig:{getRowClass:function(record,rowIndex,rowParams,store){return record.get('TimeKeepingType')==1?'TimeSheetPicker-grid-raw':'';}},sort:'SortOrder',columns:{items:[{xtype:'misacolumn',showFilterButton:false,text:'Ký hiệu',dataIndex:"TimeSheetSignCode",sortable:false,readOnly:true,width:120},{xtype:'misacolumn',showFilterButton:false,text:'Tên ký hiệu chấm công',dataIndex:"TimeSheetSignName",sortable:false,readOnly:true,flex:1,minWidth:200}]},customStoreParameter:function(operation){return{apply:{"customParam":JSON.stringify({OrganizationID:MISA.ContextData.OrganizationID,TimeSheetType:me.timeSheetType,RecievedType:me.recievedType}),"limit":0,"filterHeader":{}}};}};picker=Ext.create('MISA.Control.MISAGridPanel',config);me.store=picker.store;me.isFreeText=true;me.disableCreateProxy=false;picker.store.proxy.combobox=me;me.onBindStore(me.store);picker.refresh=function(){picker.clearSelection();};me.matchFieldWidth=false;break;case 'GetBudgetChapterActive':me.suspendCheckChange=true;var gridId=me.id+'_grid_picker';var config={floating:true,id:gridId,cls:'m-gridpanel m-grid-budgetChapter '+me.triggerGridCls,"itemKey":"BudgetChapterID","entityName":"BudgetChapter","getDataURL":"~/Service/DictionaryService.svc/json/GetAllBudgetChapter",autoGenerateStore:true,createFullModel:true,customModelFields:'BudgetChapterID,BudgetChapterName,BudgetChapterCode',width:500,maxHeight:268,editable:false,filterable:true,filterRemote:false,selModel:Ext.create('Ext.selection.CheckboxModel',{mode:'MULTI',showHeaderCheckbox:true,checkOnly:true,headerWidth:60,listeners:{selectionChange:function(e,record,eventManager){var selected=e.selected.items,cboVal=selected.length>0?Ext.pluck(Ext.pluck(selected,'data'),'BudgetChapterCode').join(', '):'';if(selected.length==e.store.data.length){cboVal="Tất cả";}
if(me.getPicker().isVisible()){me.setRawValue(cboVal);}}},}),listeners:{},columns:{items:[{xtype:'misacolumn',showFilterButton:true,text:'Mã chương',dataIndex:"BudgetChapterCode",sortable:false,readOnly:true,width:120},{xtype:'misacolumn',showFilterButton:true,text:'Tên chương',dataIndex:"BudgetChapterName",sortable:false,readOnly:true,flex:1,minWidth:200}]},customStoreParameter:function(operation){return{apply:{"active":1,}};}};picker=Ext.create('MISA.Control.MISAGridPanel',config);picker.store.reload();me.store=picker.store;me.isFreeText=true;me.disableCreateProxy=false;picker.store.proxy.combobox=me;me.onBindStore(me.store);picker.refresh=function(){picker.clearSelection();};me.matchFieldWidth=false;break;case "GetPaymentSourceActive":var gridId=me.id+'_grid_picker';var config={floating:true,id:gridId,cls:'m-gridpanel m-grid-paymentSource',"itemKey":"PaymentSourceID","entityName":"PaymentSourceToSalaryTable","getDataURL":"~/Service/DictionaryService.svc/json/GetPaymentSourceByOrgIDInActive",autoGenerateStore:true,createFullModel:false,customModelFields:'PaymentSourceID,PaymentSourceName,PaymentSourceCode',width:450,maxHeight:400,editable:true,listeners:{edit:function(item,e){}},columns:{items:[{xtype:'misacolumn',showFilterButton:false,text:'Nguồn',dataIndex:"PaymentSourceName",sortable:false,readOnly:true,flex:1},{xtype:'misanumbercolumn',showFilterButton:false,text:'Số phân bổ',dataIndex:"PaymentSourceAmount",sortable:false,allowBlank:true,minValue:0,dataType:MISA.Enumeration.DataType.MoneyType,emptyCellText:'<text style="color: rgb(117, 117, 117)">Nhập số tiền phân bổ ...<text>',flex:1}]},customStoreParameter:function(operation){return{apply:{"customParam":1}};}};picker=Ext.create('MISA.Control.MISAGridPanel',config);me.store=picker.store;me.isFreeText=true;me.disableCreateProxy=false;picker.store.proxy.combobox=me;me.onBindStore(me.store);picker.refresh=function(){};me.matchFieldWidth=false;break;case "GetTimeReceived":var gridId=me.id+'_grid_picker';var config={floating:true,id:gridId,cls:'m-gridpanel m-grid-timesheet',"itemKey":"TimeReceivedID","entityName":"TimeReceived","getDataURL":"~/Service/DictionaryService.svc/json/GetGetTimeReceived",autoGenerateStore:true,createFullModel:false,customModelFields:'TimeReceivedID, TimeReceivedName',width:180,maxHeight:400,editable:true,listeners:{edit:function(item,e){}},selModel:Ext.create('Ext.selection.CheckboxModel',{mode:'MULTI',showHeaderCheckbox:false,checkOnly:true,headerWidth:30}),columns:{items:[{xtype:'misacolumn',showFilterButton:false,sortable:false,readOnly:true,text:'',dataIndex:"TimeReceivedName",flex:1}]},customStoreParameter:function(operation){return{apply:{"customParam":1}};}};picker=Ext.create('MISA.Control.MISAGridPanel',config);me.store=picker.store;me.disableCreateProxy=false;picker.store.proxy.combobox=me;me.onBindStore(me.store);picker.refresh=function(){};me.matchFieldWidth=false;break;default:picker=me.callParent(arguments);break;}
if(picker&&picker.cls&&me.pickerCls){picker.cls=picker.cls+' '+me.pickerCls;}
return picker;},checkChangeQueryParam:function(ignoreKeys){var me=this,lastParam=me.lastRequestParam,igk=ignoreKeys||[],hasChange=false;if(lastParam){igk.push('query');var currentParam=me.getCurrentRequestParam();for(var i in currentParam){if(igk.indexOf(i)==-1&&!me.checkRequestParamEquals(currentParam,lastParam,i)){hasChange=true;break;}}}else{hasChange=true;}
return hasChange;},getCurrentRequestParam:function(){var p=this.getStore().readParameters().apply;p.query=this.getInputTextValue();return p;},expand:function(){var me=this,item;me.callParent(arguments);switch(me.pickerType){case 'TimeSheetSign':case 'TimeSheetSignOvertime':var rawValue=me.getRawValue();rawValue=rawValue.replaceAll(me.rawValueSplitSeperator,me.rawValueSplitSeperator.trimRight());var arrTimeSheetSign=rawValue.split(me.rawValueSplitSeperator.trimRight());me.store.clearFilter();var picker=me.getPicker(),fn=function(){if(!me.isExpanded){me.expand();}else{picker.setSelection(null);picker.store.data.items.filter(function(e){e.set('TotalHour',null);})
for(var i=0;i<arrTimeSheetSign.length;i++){var arrSignValue=arrTimeSheetSign[i].split(':');var iTimeSign=picker.store.data.items.filter(function(e){if(e.data.hasOwnProperty('TimeSheetSignCode')&&e.get('TimeSheetSignCode')==arrSignValue[0].trim()){return e}});if(iTimeSign.length>0){item=iTimeSign.first();if(arrSignValue.length>1){if(!Ext.isEmpty(arrSignValue[1].trim())){if(MISAJSON.parse(arrSignValue[1])<1000){item.set('TotalHour',MISAJSON.parse(arrSignValue[1].trim()));}else{item.set('TotalHour',999.99);}}else{item.set('TotalHour',0.00);}}
picker.getSelectionModel().select(item,true);}}
picker.store.commitChanges();}};picker.store.load({callback:fn});break;case 'GetTimeReceived':var rawValue=me.getRawValue();rawValue=rawValue.replaceAll(', ',', '.trimRight());var arrTimeSheetSign=rawValue.split(', '.trimRight());var picker=me.getPicker(),fn=function(){for(var i=0;i<arrTimeSheetSign.length;i++){var arrSignValue=arrTimeSheetSign[i].split(':');var iTimeSign=picker.store.data.items.filter(function(e){if(e.data.hasOwnProperty('TimeReceivedName')&&e.get('TimeReceivedName')==arrSignValue[0].trim()){return e}});if(iTimeSign.length>0){item=iTimeSign.first();picker.getSelectionModel().select(item,true);}}
picker.store.commitChanges();};if(!Ext.isEmpty(rawValue)){picker.store.load({callback:fn});}else{picker.store.load({});}
break;}},setRawTextColumn:function(picker){var me=this,selectedRecord=picker.getSelection(),text='',splitSeperator;lastRecord=selectedRecord.last();if(selectedRecord.length>0){selectedRecord.forEach(function(record){splitSeperator=record!=lastRecord?me.rawValueSplitSeperator:'';if(record.get('TotalHour')){text+=record.get('TimeSheetSignCode')+me.valueSplitSeperatorInSign+record.get('TotalHour')+splitSeperator;}else{text+=record.get('TimeSheetSignCode')+splitSeperator;}});}
return text;},buildStore:function(){var me=this;var store=null;if(me.config&&(!me.store||"misastore"!==me.store.type)&&me.autoGenerateStore&&!Ext.isEmpty(me.entityName)){store={id:me.id+"_Store",type:'misastore',pageSize:me.getStorePageSize(),autoLoad:me.autoLoadData,isPagingStore:true,parentCombobox:me,model:me.buildModel(me.id+'_'+me.entityName+"_Model",me.entityName,me.buildColumn(),null),proxy:me.buildProxy(),};if(!me.disableCreateProxy){store.readParameters=function(operation){var columns=[];store.model.getFields().filter(function(i){columns.push(i.name);});var sort=me.sort;if(!Ext.isEmpty(me.displayField)&&Ext.isEmpty(sort)){sort=me.displayField;}
var d={apply:{entityName:me.entityName,filterFields:me.filterFields,columns:columns.join(','),sort:sort,}}
if(me.customStoreParameter){customProps(d.apply,me.customStoreParameter(operation).apply);}
MISA.Service.processData(d);return d;}}}
return store;},buildColumn:function(){var me=this;var columnsToModel=[];if(!Ext.isEmpty(me.valueField)&&columnsToModel.indexOf(me.valueField)<0){columnsToModel.push(me.valueField);}
if(!Ext.isEmpty(me.displayField)&&columnsToModel.indexOf(me.displayField)<0){columnsToModel.push(me.displayField);}
var columns=[];if(!me.createFullModel){if(me.customModelFields){var arr=me.customModelFields.split("|");if(arr){columns=arr;}}
if(columnsToModel){Ext.each(columnsToModel,function(f){if(columns.indexOf(f)<0){columns.push(f);}});}
if(me.columnsConfig&&me.columnsConfig.length>0){Ext.each(me.columnsConfig,function(f){if(columns.indexOf(f["DataField"])<0){columns.push(f["DataField"]);}});}
if(this.isTreeDisplay){if(!columns.contains("MISACode")){columns.push("MISACode");}
if(!columns.contains("ParentID")){columns.push("ParentID");}}}
else{columns=null;}
return columns;},buildModel:function(modelId,entityName,columns,itemId,phantomKey){var me=this;return MISA.CommonFn.buildModel(modelId,entityName,columns,itemId,phantomKey);},getStorePageSize:function(){return this.pagingData?(this.pageSize||10):0;},buildProxy:function(){var me=this;var proxy=null;if(me.customProxy){proxy=me.customProxy;}else{if(!Ext.isEmpty(me.getDataURL)&&!me.disableCreateProxy){proxy={type:"misaajaxproxy",reader:{getResponseData:function(response){return me.getProxyReaderResponseData(response,this);},type:"json",rootProperty:"Data",totalProperty:"TotalCount",},url:MISA.CommonFn.getAppUrl(me.getDataURL),json:true,actionMethods:Ext.apply({},{read:"POST"},Ext.data.proxy.Ajax.prototype.actionMethods),dynamicParams:Ext.JSON.decode(me.dynamicParams),};}else if(me.disableCreateProxy){proxy={type:"pagingmemory",};}else if(!me.disableCreateProxy){}}
if(proxy){proxy.combobox=me;}
return proxy;},getProxyReaderResponseData:function(response,jsonReader){var me=this;if(response&&response.responseText){var obj=Ext.decode(response.responseText).d;if(obj.Status){var value=Ext.decode(obj.Data),data={};if(value&&Ext.isArray(value.Data)){data[jsonReader._successProperty]=true;data[jsonReader._rootProperty]=value.Data;data[jsonReader._totalProperty]=value.TotalCount;}
if(value.TotalCount===0&&me.isExpanded===true){me.collapse(true);}
return data;}
else{return jsonReader.createReadError(obj.Message);}}},collapse:function(forceCollapce){var me=this,isExpanded=me.isExpanded;if(forceCollapce===true){me.callParent(arguments);}else{if(!me.getStore().loading){me.callParent(arguments);}}
switch(me.pickerType){case 'TimeSheetSignOvertime':case 'TimeSheetSign':if(isExpanded){var picker=me.getPicker();var text=me.setRawTextColumn(picker);me.setRawValue(text);}
break;}},getCurrentRequestParam:function(){if(typeof this.getStore().readParameters==="function"){return this.getStore().readParameters().apply;}else{return null;}},buildColumnsConfig:function(){var me=this;if(!me.listConfig){var arr;if(!me.columnConfigJson){arr=[{DataField:me.displayField}];}else{arr=Ext.JSON.decode(me.columnConfigJson);}
me.columnsConfig=arr;}},buildFilterFields:function(){var me=this;if(!me.disableCreateProxy){if(!me.filterFields){var filterFields=[],e=MISA.CommonFn.getEntityConfig(me.entityName);if(me.columnsConfig&&e){me.columnsConfig.filter(function(i){if(i&&e.hasOwnProperty(i.DataField)){filterFields.push(i.DataField);}});}
if(!filterFields.contains(me.displayField)&&e&&e.hasOwnProperty(me.displayField)){filterFields.push(me.displayField);}
me.filterFields=filterFields.join('|');}}},getOperationFilter:function(columnConfig){var me=this,res='*';if(columnConfig&&columnConfig.OperationFilter){res=me.getOperandFilterEnumByKey(MISA.Enumeration.FilterMenuTag[columnConfig.OperationFilter]);}
return res;},buildColumnTemplate:function(){var me=this;MISA.ComboboxFn.buildColumnTemplate(me);},bindingData:function(data,config){var me=this,config=cf||{},bFlatDoneBinding=false;if(data[me.setField]!==null&&data[me.setField]!==undefined){if(me.isFreeText||me.textToBinding){me.setRawValue(data[me.setField]);}
else if(!me.disableCreateProxy){var value=data[me.setField],text=data.hasOwnProperty(me.setFieldText)?data[me.setFieldText]:(data.hasOwnProperty(me.displayField)?data[me.displayField]:data[me.valueField]);if(!Ext.isEmpty(value)&&!me.autoLoadData&&me.isSetDataToStoreDone!==true){var d={};d[me.valueField]=value;d[me.displayField]=text;if(me.columnsConfig){var key='';for(var i=0;i<me.columnsConfig.length;i++){key=me.columnsConfig[i].DataField;if(!d[key]&&data[key]!==undefined){d[key]=data[key];}}}
if(me.customModelFields){me.customModelFields.split('|').filter(function(i){if(!d[i]&&data[i]!==undefined){d[i]=data[i];}});}
if(config.maping&&config.maping.combobox){var cf=config.maping.combobox[me.setField];if(cf){for(var i in cf){if(!d[i]&&data[cf[i]]!==undefined){d[i]=data[cf[i]];}}}}
me.store.loadData([d]);me.setValue(data[me.setField],true);me.originalValue=data[me.setField];me.reset();bFlatDoneBinding=true;}else if(Ext.isEmpty(value)&&me.forceSelection===false){me.reset();me.setRawValue(Ext.isEmpty(text)?null:text);me.originalValue=Ext.isEmpty(text)?null:text;bFlatDoneBinding=true;}}
if(bFlatDoneBinding===false){me.setValue(data[me.setField],true);me.originalValue=data[me.setField];me.reset();bFlatDoneBinding=true;}}else{me.setValue(null);}},setValue:function(value,suspendEvent){var me=this;if(suspendEvent){me.suspendEvent('change');}
me.callParent(arguments);if(suspendEvent){me.resumeEvent('change');}
if(me.picker&&typeof(me.picker.clearHighlight)=="function"){me.picker.clearHighlight();}},initValue:function(){var me=this;me.callParent(arguments);if(me.value==undefined&&me.selectedIndex!=undefined&&me.selectedIndex>=0){if(me.getStore()&&me.getStore().getCount()>0){var item=me.getStore().getAt(me.selectedIndex);if(item.data.hasOwnProperty(me.valueField)){me.value=item.data[me.valueField];}}}
me.setValue(me.value,true);},getSelectedItem:function(){var me=this,r=null;if(me.getRawValue()){r=me.findRecord(me.valueField||me.displayField,me.getValue());}
return r;},setSelectedIndex:function(index,suspendEvent){var me=this,items=me.getStore().getData().items;if(items.length>index){me.setValue(items[index],suspendEvent);}else{me.selectedIndex=index;}},getDisplayText:function(){var me=this;return me.getRawValue();},doRawQuery:function(){var me=this,rawValue=me.inputEl.dom.value;if(Ext.isString(rawValue)){rawValue=Ext.String.trim(rawValue);}
if(me.multiSelect){rawValue=rawValue.split(me.delimiter).pop();}
me.doQuery(rawValue,false,true);},getValue:function(){var me=this,value=me.callParent(arguments);if(!me.getRawValue()){value=null;}
return value;},getRecordHighlightedItem:function(){var me=this,rec=null;if(me.picker){var oHighlightedItem=me.picker.highlightedItem;if(oHighlightedItem){var store=me.picker.selectionModel.getStore();if(store){var oHighlightedItemIndex=me.picker.indexOf(oHighlightedItem);rec=store.getAt(oHighlightedItemIndex);}}}
return rec;},reset:function(){var me=this;me.callParent();if(me.picker){me.picker.clearHighlight();}},getOperandFilterEnumByKey:function(key){var res='*';switch(key){case MISA.Enumeration.FilterMenuTag.Equals:res="="
break;case MISA.Enumeration.FilterMenuTag.StartsWith:res="+"
break;case MISA.Enumeration.FilterMenuTag.EndsWith:res="-"
break;case MISA.Enumeration.FilterMenuTag.Contains:res="*"
break;case MISA.Enumeration.FilterMenuTag.DoNotContain:res="!"
break;case MISA.Enumeration.FilterMenuTag.LessThan:res="<"
break;case MISA.Enumeration.FilterMenuTag.LessThanOrEqual:res="<="
break;case MISA.Enumeration.FilterMenuTag.GreaterThan:res=">"
break;case MISA.Enumeration.FilterMenuTag.GreaterThanOrEqual:res=">="
break;}
return res;},getErrors:function(value){var me=this,errors=me.callParent(arguments);return me.getErrorsCustom(value,errors);},getErrorsCustom:function(value,errors){return errors;},});